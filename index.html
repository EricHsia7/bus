<script>
const LS = window.localStorage
const SS = window.sessionStorage
let realtime_api = 'https://tcgbusfs.blob.core.windows.net/blobbus/GetEstimateTime.gz'
let stopName_api = 'https://tcgbusfs.blob.core.windows.net/blobbus/GetStop.gz'
let routes_api = 'https://tcgbusfs.blob.core.windows.net/blobbus/GetRoute.gz'

var realtime_json = {}
var stopName_json = {'loaded':false,'c':{}}
var routes_json =  {'loaded':false,'c':{}}
var c_routeid = 0
var o_routeid
var realtime_lo = 0
function skeletonScreen() {
var j =[]
var ll = Math.floor(window.innerHeight/45)+5
for(var y=0;y<ll;y++) {
j.push({'sk':true,'b':0})
}
  for(var y=0;y<ll;y++) {
j.push({'sk':true,'b':1})
}
  printStop(j,'skeleton')
}
function setRouteD() {
  if(routes_json.loaded) {
    var this_route = routes_json.c['b_' + c_routeid]
    var dep = this_route.dep
    var des = this_route.des
    var name = this_route.n
    $('.container .tabs .tab[direction="departure"] span').text(des)
    $('.container .tabs .tab[direction="destination"] span').text(dep)
    $('.container .title .routename').text(name)
    switchDirection('departure')
  }
}
function printStop(k,c) {
  
  var htm={}
  var l= k.length
var g = false
  if(c === 'skeleton') {
g = true
}
for(var w = 0;w<l;w++) {
  var displayName = k[w].StopID
  var s = {}
if(g) {
s = {'b':k[w].b}
    displayName = ''
}
  else {

  if(stopName_json.loaded) {
    s = stopName_json.c['b_' + k[w].StopID]
displayName = s.n 
}
  }
  
  if(!(htm.hasOwnProperty('h_' + s.b))) {
    htm['h_' + s.b] = []
  }
  if(g) {
var status = {'status':10,'text':''}
}
else {
var status = timeStatus(k[w].EstimateTime)
}
  
htm['h_' + s.b].push('<li class="stop" l="' + g + '"><div class="name">' + displayName + '</div><div class="status" status="' + status.status + '">' + status.text + '</div></li>')
}
  
$('.container .route[direction="departure"]').html(htm['h_0'].join(''))
  $('.container .route[direction="destination"]').html(htm['h_1'].join(''))
  
  
}
function timeStatus(t) {
  t = parseInt(t)
  var minute = Math.round(t/60) + '分'
  if(t === -3) {
    return {status:6,text:'末班駛離'}
  }
  if(t === -4) {
    return {status:5,text:'今日未營運'}
  }
  if(t === -2) {
    return {status:4,text:'交管不停靠'}
  }
  if(t === -1) {
    return {status:3,text:'未發車'}
  }
  if(t <= 180) {
    if(t <= 100) {
    return {status:2,text:'進站中'}
    }
    else {
      return {status:1,text:minute}
    }
  }
  else {
    return {status:0,text:minute}
  }
}
function findStop(j,id) {
  var res = []
  var o = j.BusInfo
  var l = o.length
  for(var w = 0;w<l;w++) {
    if(o[w].RouteID == id) {
      res.push(o[w])
    }
  }
  
 res.sort(function (a, b) {
      return stopName_json.c['b_' + a.StopID].s - stopName_json.c['b_' + b.StopID].s
    });
  return res
}
function updateRealtimeJson() {
 $.ajax({
        type: 'GET', url: realtime_api, async: true, cache: false, xhrFields: { responseType: 'blob' }, success: function (data) {
        
        var b = new Blob([data.slice(0,data.size)], {type: 'application/gzip'});
          
          b.arrayBuffer().then(bf => {
            var z = pako.inflate(bf,{to:'string'})
        realtime_json = JSON.parse(z)
            var s = findStop(realtime_json,c_routeid)
            
           printStop(s)
         setTimeout(function() {updateRealtimeJson()},10000);
            
          });
      },error:function(){
        setTimeout(function() {updateRealtimeJson()},1000);
      }});
}

var stopsDataShortName = [
  {'source':'routeId','short':'r'},
  {'source':'nameZh','short':'n'},
  {'source':'nameEn','short':false},
{'source':'seqNo','short':'s'},
  {'source':'goBack','short':'b'},
  {'source':'nameEn','short':false},
  {'source':'address','short':false},
  {'source':'longitude','short':false},
   {'source':'latitude','short':false},
  {'source':'showLon','short':false},
  {'source':'showLat','short':false},
  {'source':'vector','short':false},
  
]

var sdsn_len = stopsDataShortName.length

function getStops() {
  var t = new Date().getTime()
  if(SS.hasOwnProperty('bus_stops_t')) {
    if(t-parseInt(String(SS.getItem('bus_stops_t'))) < 60*60*24*15 ) {
      stopName_json.c = JSON.parse(String(SS.getItem('bus_stops')))
            stopName_json.loaded = true
      
    }
  }
  if(stopName_json.loaded) {
    
  }
  else {
 $.ajax({
        type: 'GET', url: stopName_api, async: true, cache: false, xhrFields: { responseType: 'blob' }, success: function (data) {
        
        var b = new Blob([data.slice(0,data.size)], {type: 'application/gzip'});
          
          b.arrayBuffer().then(bf => {
            var z = pako.inflate(bf,{to:'string'})
        var o = JSON.parse(z).BusInfo
        
        var iqq = {}
         
var pl= o.length
for(var j= 0;j<pl;j++) {
  var jjj = o[j]
  for(var g = 0;g<sdsn_len;g++) {
    var thsS = stopsDataShortName[g]
  if(!(thsS === false)) {
      jjj[thsS.short] = jjj[thsS.source]
    }
  delete jjj[thsS.source]
  }
  iqq['b_' + o[j].Id] = o[j]
}
            stopName_json.c = iqq
            /*
     SS.setItem('bus_stops',JSON.stringify(iqq))
            SS.setItem('bus_stops_t',new Date().getTime())
*/
            
            stopName_json.loaded = true
            if(realtime_lo === 0) {
    realtime_lo = 1
            updateRealtimeJson()
            }
            
            //()
          });
      }});
}
}


var routesDataShortName = [
  {'source':'providerId','short':false},
  {'source':'providerName','short':false},
  {'source':'nameZh','short':'n'},
  {'source':'nameEn','short':false},
  {'source':'aliasName','short':'an'},
  {'source':'pathAttributeId','short':false},
  {'source':'pathAttributeNId','short':false},
  {'source':'pathAttributeName','short':false},
  {'source':'pathAttributeEname','short':false},
  {'source':'buildPeriod','short':false},
  {'source':'departureZh','short':'dep'},
  {'source':'destinationZh','short':'des'},
  {'source':'departureEn','short':false},
  {'source':'destinationEn','short':false},
  {'source':'goFirstBusTime','short':false},
  {'source':'goLastBusTime','short':false},
  {'source':'backFirstBusTime','short':false},
  {'source':'backLastBusTime','short':false},
  {'source':'offPeakHeadway','short':false},
  {'source':'roadMapUrl','short':false},
  {'source':'headwayDesc','short':false},
  {'source':'holidayGoFirstBusTime','short':false},
  {'source':'holidayBackFirstBusTime','short':false},
  {'source':'holidayBackLastBusTime','short':false},
  {'source':'holidayGoLastBusTime','short':false},
  {'source':'holidayBusTimeDesc','short':false},
  {'source':'realSequence','short':'rs'},
  {'source':'holidayHeadwayDesc','short':false},
  {'source':'holidayOffPeakHeadway','short':false},
  {'source':'holidayPeakHeadway','short':false},
  {'source':'segmentBufferEn','short':false},
{'source':'ticketPriceDescriptionZh','short':false},
{'source':'ticketPriceDescriptionEn','short':false},
  {'source':'peakHeadway','short':false},
  {'source':'ttiaPathId','short':false},
  {'source':'segmentBufferZh','short':false},
  {'source':'busTimeDesc','short':false},
  {'source':'distance','short':false},
  {'source':'NId','short':false},
  {'source':'genus','short':false},
  {'source':'Id','short':false}
]
var rdsn_len = routesDataShortName.length

function getRoutes() {
  var t = new Date().getTime()
  if(LS.hasOwnProperty('bus_routes_t')) {
    if(t-parseInt(String(LS.getItem('bus_routes_t'))) < 60*60*24*15 ) {
      routes_json.c = JSON.parse(String(LS.getItem('bus_routes')))
      
            routes_json.loaded = true
      
    }
  }
  if(routes_json.loaded) {
    setRouteD()
  }
  else {
   
 $.ajax({
        type: 'GET', url: routes_api, async: true, cache: false, xhrFields: { responseType: 'blob' }, success: function (data) {
        
        var b = new Blob([data.slice(0,data.size)], {type: 'application/gzip'});
          
          b.arrayBuffer().then(bf => {
            var z = pako.inflate(bf,{to:'string'})
        var o = JSON.parse(z).BusInfo
     var iqq = {}
var pl= o.length

for(var j= 0;j<pl;j++) {
  var jjj = o[j]
  var id = o[j].Id
  for(var g = 0;g<rdsn_len;g++) {
    var thsS = routesDataShortName[g]
  if(!(thsS.short === false)) {
      jjj[thsS.short] = jjj[thsS.source]
    }
  delete jjj[thsS.source]
    
  }
  iqq['b_' + id] = o[j]
}
            routes_json.c = iqq
          LS.setItem('bus_routes',JSON.stringify(iqq))
            LS.setItem('bus_routes_t',new Date().getTime())
            routes_json.loaded = true
            setRouteD()
          });
      }});
  }
}

function showRoute(id) {
  skeletonScreen()
  c_routeid = id
  getStops()
  getRoutes()
  
}


showRoute(10747)
 function switchDirection(d) {
$('.container .routes').attr('display',d)
  var line = 0;
  var content = 0;
  var tabwidth = $(".tab-line-box").width();
  var contentwidth = $(".content-box").width();
  var y = 0
  if(d === 'destination') {
y = 1
}
    line = (1 / 2) * y * tabwidth;
  $(".tab-line-box2").css({"transform": "translateX(" + line + "px)","transition": "0.35s"});
  
  $(".tab-line").css({"width":$('.container .tabs .tab[direction="' + d + '"] span').width() + "px","transition": "0.35s"});
  
}
$('.container .tabs .tab').click(function () {
  var d = $(this).attr('direction')
  switchDirection(d)
});
</script>
