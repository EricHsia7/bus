{"version":3,"file":"231a5c2e9ec8fea197c7.js","mappings":"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","sources":["webpack://bus/webpack/universalModuleDefinition","webpack://bus/./src/data/analytics/bus-arrival-time/getBusArrivalTimes-worker.ts"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"bus\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"bus\"] = factory();\n\telse\n\t\troot[\"bus\"] = factory();\n})(self, () => {\nreturn ","import { PersonalScheduleArray } from '../../personal-schedule/index';\nimport { BusArrivalTimeDataGroupArray, BusArrivalTimes } from './index';\n\ninterface task {\n  personalSchedules: PersonalScheduleArray;\n  busArrivalTimeDataGroups: BusArrivalTimeDataGroupArray;\n  chartWidth: number;\n  chartHeight: number;\n  taskID: string;\n  port: any;\n}\n\nlet taskQueue: Array<task> = [];\nlet isProcessing: boolean = false;\n\n// Setup message handling (works for dedicated or shared workers)\nif ('onconnect' in self) {\n  self.onconnect = function (e) {\n    const port = e.ports[0];\n    port.onmessage = function (event) {\n      const [personalSchedules, busArrivalTimeDataGroups, chartWidth, chartHeight, taskID] = event.data;\n      taskQueue.push({ personalSchedules, busArrivalTimeDataGroups, chartWidth, chartHeight, taskID, port });\n      processWorkerTask();\n    };\n  };\n} else {\n  const port = self;\n  self.onmessage = function (event) {\n    const [personalSchedules, busArrivalTimeDataGroups, chartWidth, chartHeight, taskID] = event.data;\n    taskQueue.push({ personalSchedules, busArrivalTimeDataGroups, chartWidth, chartHeight, taskID, port });\n    processWorkerTask();\n  };\n}\n\nconst fontWeight = 400;\nconst fontSize = 10;\nconst fontFamily: string = `'Noto Sans TC', sans-serif`;\n\nlet canvas;\nlet ctx;\nlet supportOffscreenCanvas: boolean = false;\nif (typeof OffscreenCanvas !== 'undefined') {\n  canvas = new OffscreenCanvas(100, 100);\n  ctx = canvas.getContext('2d') as OffscreenCanvasRenderingContext2D;\n  ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;\n  ctx.textBaseline = 'top';\n  supportOffscreenCanvas = true;\n}\n\n// Main processing function\nfunction processWorkerTask(): void {\n  if (isProcessing || taskQueue.length === 0) return;\n  isProcessing = true;\n\n  // Dequeue the next task\n  const { personalSchedules, busArrivalTimeDataGroups, chartWidth, chartHeight, taskID, port }: task = taskQueue.shift();\n\n  const result: BusArrivalTimes = {};\n\n  // For each personalSchedule, build an SVG graph\n  for (const personalSchedule of personalSchedules) {\n    const startIndex = personalSchedule.period.start.hours * 60 + personalSchedule.period.start.minutes;\n    const endIndex = personalSchedule.period.end.hours * 60 + personalSchedule.period.end.minutes;\n    const barWidth = chartWidth / (endIndex - startIndex);\n    for (const busArrivalTimeDataGroup of busArrivalTimeDataGroups) {\n      if (personalSchedule.days.indexOf(busArrivalTimeDataGroup.day) < 0) {\n        continue;\n      }\n      const statsMax = busArrivalTimeDataGroup.max;\n      const statsArray = busArrivalTimeDataGroup.stats.slice(startIndex, endIndex);\n      const statsArrayLength = statsArray.length;\n\n      // Gridline and labels\n      let verticalGridlineLabels = '';\n      let verticalGridlinePathCommand = '';\n      let verticalGridlineInterval = 0; // minutes\n      if (statsArrayLength / 30 <= 3) {\n        verticalGridlineInterval = 10;\n      } else {\n        verticalGridlineInterval = 30;\n      }\n      const verticalGridlineQuantity = Math.floor(statsArrayLength / verticalGridlineInterval);\n      const verticalGridlineGap = chartWidth / verticalGridlineQuantity;\n      for (let i = verticalGridlineQuantity - 1; i >= 0; i--) {\n        const x = 0.35 / 2 + i * verticalGridlineGap;\n        verticalGridlinePathCommand += ` M${x},0`;\n        verticalGridlinePathCommand += ` L${x},${chartHeight}`;\n        // the stroke alignment is \"center\"\n        const labelTime = startIndex + i * verticalGridlineInterval;\n        const labelMinutes = labelTime % 60;\n        const labelHours = (labelTime - labelMinutes) / 60;\n        const label = `${labelHours.toString().padStart(2, '0')}:${labelMinutes.toString().padStart(2, '0')}`;\n        let labelWidth = 30;\n        let labelHeight = 12;\n        if (supportOffscreenCanvas) {\n          const textMeasurement = ctx.measureText(label) as TextMetrics;\n          labelWidth = textMeasurement.width;\n          labelHeight = textMeasurement.actualBoundingBoxDescent;\n        }\n        const y = (chartHeight - labelHeight) / 2;\n        verticalGridlineLabels += `<text x=\"${x}\" y=\"${y}\" transform=\"rotate(-90 ${(x + x + labelWidth) / 2} ${(y + y + labelHeight) / 2})\" font-weight=\"${fontWeight}\" font-size=\"${fontSize}\" font-family=\"${fontFamily}\" component=\"label\">${label}</text>`;\n      }\n      const verticalGridline = `<path d=\"${verticalGridlinePathCommand}\" fill=\"none\" stroke-width=\"0.35\" component=\"vertical-gridline\"/>`;\n\n      // Bottom line\n      const bottomLinePathCommand = `M0,${chartHeight} L${chartWidth},${chartHeight - 0.35 / 2}`;\n      const bottomLine = `<path d=\"${bottomLinePathCommand}\" fill=\"none\" stroke-width=\"0.35\" component=\"bottom-line\"/>`;\n\n      // Bars\n      let barsPathCommand = '';\n      barsPathCommand += `M${chartWidth},${chartHeight}`;\n      for (let j = statsArrayLength - 1; j >= 0; j--) {\n        let x = ((j + 1) / statsArrayLength) * chartWidth; // Shift right for correct alignment\n        let y = (1 - statsArray[j] / statsMax) * chartHeight;\n        barsPathCommand += ` L${x},${y}`;\n        barsPathCommand += ` L${x - barWidth},${y}`;\n        barsPathCommand += ` L${x - barWidth},${chartHeight}`;\n      }\n      barsPathCommand += ' Z';\n      const bars = `<path d=\"${barsPathCommand}\" stroke=\"none\" stroke-width=\"0\" component=\"bars\"/>`;\n\n      const svg = `<svg width=\"${chartWidth}\" height=\"${chartHeight}\" viewBox=\"0 0 ${chartWidth} ${chartHeight}\" xmlns=\"http://www.w3.org/2000/svg\">${verticalGridline}${verticalGridlineLabels}${bottomLine}${bars}</svg>`;\n      const stopKey = `s_${busArrivalTimeDataGroup.id}`;\n      if (!result.hasOwnProperty(stopKey)) {\n        result[stopKey] = [];\n      }\n      result[stopKey].push({\n        personalSchedule: personalSchedule,\n        chart: svg,\n        day: busArrivalTimeDataGroup.day\n      });\n    }\n  }\n\n  // Send the complete HTML back to the main thread\n  port.postMessage([result, taskID]);\n\n  isProcessing = false;\n  processWorkerTask(); // Process next task in the queue if any\n}\n"],"names":["root","factory","exports","module","define","amd","self","taskQueue","isProcessing","onconnect","e","port","ports","onmessage","event","_event$data","_slicedToArray","data","personalSchedules","busArrivalTimeDataGroups","chartWidth","chartHeight","taskID","push","processWorkerTask","_event$data2","canvas","ctx","fontWeight","fontSize","fontFamily","supportOffscreenCanvas","length","_step","_taskQueue$shift","shift","result","_iterator","_createForOfIteratorHelper","s","n","done","_step2","personalSchedule","value","startIndex","period","start","hours","minutes","endIndex","end","barWidth","_iterator2","busArrivalTimeDataGroup","days","indexOf","day","statsMax","max","statsArray","stats","slice","statsArrayLength","verticalGridlineLabels","verticalGridlinePathCommand","verticalGridlineInterval","verticalGridlineQuantity","Math","floor","verticalGridlineGap","i","x","concat","labelTime","labelMinutes","label","toString","padStart","labelWidth","labelHeight","textMeasurement","measureText","width","actualBoundingBoxDescent","y","verticalGridline","bottomLinePathCommand","bottomLine","barsPathCommand","j","bars","svg","stopKey","id","hasOwnProperty","chart","err","f","postMessage","OffscreenCanvas","getContext","font","textBaseline"],"sourceRoot":""}